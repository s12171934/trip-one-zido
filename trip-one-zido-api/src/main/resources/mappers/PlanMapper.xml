<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.triponezidoapi.mappers.PlanMapper">
    <select id="getPlanList" parameterType="com.example.triponezidoapi.dto.RequestListInfo" resultType="com.example.triponezidoapi.dto.ResponseContentList">
        SELECT
            c.id,
            c.title,
            p.grade,
            (
            SELECT
                photo
            FROM
                photo
            WHERE
                content_id = c.id
            ) photo,
            (
            SELECT
                COUNT(*)
            FROM
                bookmark
            WHERE
                content_id = c.id
            ) bookmark_count,
            (
            SELECT
                COUNT(*)
            FROM
                bookmark
            WHERE
                content_id = c.id AND
                member_id = #{myMemberId}
            ) my_bookmark,
            (
            SELECT
                COUNT(*)
            FROM
                good
            WHERE
                content_id = c.id
            ) good_count
        FROM
            content c,
            plan p
        WHERE
            c.id = p.id AND
            c.id IN
            (
            SELECT
                content_id
            FROM
                owner
            WHERE
                member_id = #{targetId}
            )
    </select>

    <select id="getPlan" parameterType="com.example.triponezidoapi.dto.RequestOwner" resultType="com.example.triponezidoapi.dto.Plan">
        SELECT
            p.*,
            c.title,
            (
            SELECT
                COUNT(*)
            FROM
                bookmark
            WHERE
                content_id = c.id
            ) bookmark_count,
            (
            SELECT
                COUNT(*)
            FROM
                bookmark
            WHERE
                content_id = c.id AND
                member_id = #{memberId}
            ) my_bookmark,
            (
            SELECT
                COUNT(*)
            FROM
                good
            WHERE
                content_id = c.id
            ) good_count
        FROM
            plan p,
            content c
        WHERE
            p.id = c.id AND
            p.id = #{contentId}
    </select>

    <insert id="addPlan" parameterType="com.example.triponezidoapi.dto.Plan">
        INSERT INTO plan
            (
            id,
            start_date,
            end_date,
            loc_category,
            review,
            status,
            grade
            )
        VALUE
            (
            #{id},
            #{startDate},
            #{endDate},
            #{locCategory},
            #{review},
            #{status},
            #{grade}
            )
    </insert>

    <update id="updatePlan" parameterType="com.example.triponezidoapi.dto.Plan">
        UPDATE plan
        SET
            start_date = #{startDate},
            end_date = #{endDate},
            loc_category = #{locCategory},
            review = #{review},
            status = #{startDate},
            grade = #{grade}
        WHERE
            id = #{id}
    </update>

    <insert id="addSpot" parameterType="com.example.triponezidoapi.dto.PlanSpotConnector">
        INSERT INTO
            plan_spot
            (
            plan_id,
            spot_id
            )
            VALUE
            (
            #{planId},
            #{spotId}
            )
    </insert>
</mapper>